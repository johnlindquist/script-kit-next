# Session: Improve AI Chat UX (Streaming Speed, System Messages, Input Warnings, Code Metadata)

## Files Changed
- `src/ai/window.rs` — 6 UX improvements: streaming speed display, system message styling, scroll pill word count, input length warning, chat source badge
- `src/prompts/markdown.rs` — code block header now shows line count alongside language label

## What Was Improved
1. **Streaming words/sec display** — During active streaming, shows "~X words/s" in the streaming header alongside elapsed time. After completion, the message action bar shows "Xs · ~N words · Y words/s" for quick performance insight. Only displays when streaming has been active >0.5s to avoid jittery initial numbers.
2. **System message visual distinction** — Messages with `MessageRole::System` (from presets/system prompts) now render with a distinct muted background, left border in `muted_foreground` color, italic text, and a Settings icon with "System" label instead of the assistant's MessageCircle/"Assistant".
3. **Scroll pill with streaming word count** — The "New content below" scroll pill now shows "↓ ~N new words" when streaming has generated 5+ words, giving users a sense of how much content they're missing while scrolled up.
4. **Input length warning** — Input border color shifts from normal → warning (>2000 chars) → danger (>4000 chars). The word count label in the bottom bar also changes color to match, providing visual feedback before hitting any model limits.
5. **Code block line count in header** — Code block headers now show "typescript · 15 lines" (or just "15 lines" for unlabeled blocks) when there are 2+ lines. Single-line blocks just show the language. Empty label blocks with 1 line show nothing (unchanged).
6. **Sidebar chat source badge** — Chats created from `ChatSource::ChatPrompt` or `ChatSource::Script` show a small "Prompt" or "Script" badge with a Terminal icon in the sidebar metadata row, alongside the existing model badge and message count.

## What to Avoid Repeating
- Pre-existing clippy error in `src/designs/mod.rs:906` (`implicit_saturating_sub`) — use `cargo clippy --lib -- -W clippy::all` and filter by your files, or just `cargo check --lib` for compilation
- `src/designs/mod.rs` and `src/actions/mod.rs` had unstaged changes from previous sessions — always check `git diff --stat` before committing and revert unrelated files with `git checkout --`
- `cargo fmt` must be run before commit — the pre-commit hook rejects unformatted code
- When using `.when()` chains with multiple conditions (e.g., `is_user`, `is_system`, `!is_user && !is_system`), ensure the conditions are mutually exclusive to avoid double-applying styles
- `ChatSource` derives `PartialEq` so `matches!()` macro works; `MessageRole` also derives `PartialEq` + `Copy`
