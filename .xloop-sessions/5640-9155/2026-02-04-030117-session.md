# Session: Batch 14 Builtin Action Validation Tests

**Date**: 2026-02-04
**Commit**: 5235dce
**Branch**: main

## Summary

Created batch 14 of dialog builtin action validation tests with **169 tests** across **30 categories**, continuing the series from batches 1-13.

## Files Changed

- `src/actions/dialog_builtin_action_validation_tests_14.rs` (new, ~2130 lines) — 169 tests in 30 categories
- `src/actions/mod.rs` (+4 lines: test module registration for batch 14)

## What Was Improved

### New Tests (169 across 30 categories):

1. **Path context action ordering** — 6 tests: primary is first (dir=open_directory, file=select_file), trash always last, dir/file same count, common actions present, title contains name
2. **Clipboard OCR mutual exclusivity** — 5 tests: text has no OCR, image has OCR, image more actions than text, text no open_with (macOS), image has open_with (macOS)
3. **ScriptInfo::with_all field isolation** — 5 tests: name/path set, is_script true/false, verb set, shortcut/alias set, no agent/scriptlet/suggested defaults
4. **AI command bar icon-to-section mapping** — 11 tests: Response=3, Actions=4, Attachments=2, Export=1, Help=1, Settings=1 actions per section; exact icons for copy_response, submit, new_chat, delete_chat, change_model
5. **Notes command bar section-action membership** — 6 tests: Notes=3, Edit=2, Copy=3, Export=1 in full feature; trash view only Notes section; no selection minimal=3
6. **Note switcher title rendering** — 6 tests: current gets bullet prefix, non-current no bullet, pinned overrides current icon, regular icon=File, empty placeholder, ID format
7. **Chat context edge cases** — 5 tests: zero models still has continue, no response→no copy, no messages→no clear, both flags true→max actions, current model checkmark
8. **Scriptlet custom action ordering** — 5 tests: custom after run, custom before builtins, has_action=true with value, shortcut formatted, empty returns empty
9. **File context macOS-only actions** — 3 tests (cfg(target_os="macos")): quick_look+open_with+show_info for files, dir no quick_look, file more actions than dir
10. **Cross-context description non-emptiness** — 6 tests: script, AI, path, file, clipboard, notes all have descriptions
11. **build_grouped_items_static mixed sections** — 5 tests: headers for section changes, separators no headers, none style, empty input, no section no header
12. **coerce_action_selection interleaved headers** — 7 tests: empty→None, on item→same, header→down, trailing header→up, all headers→None, out of bounds clamped, interleaved
13. **score_action stacking** — 5 tests: prefix+desc+shortcut=115+, contains=50, fuzzy=25+, description only=15, no match=0
14. **fuzzy_match edge cases** — 7 tests: ASCII subsequence, exact, empty needle, no match, needle longer, both empty, empty haystack
15. **parse_shortcut_keycaps** — 8 tests: cmd+slash, number, modifier chain, enter, escape, arrows, lowercase uppercased
16. **to_deeplink_name edge cases** — 7 tests: numeric only, all special→empty, mixed case lowered, consecutive specials collapsed, leading/trailing stripped, unicode preserved, underscores→hyphens
17. **Action with_shortcut_opt chaining** — 6 tests: None preserves, Some sets, with_shortcut sets lower, new has no shortcut_lower, title_lower cached, description_lower cached
18. **CommandBarConfig notes_style completeness** — 9 tests: search Top, Separators, anchor Top, icons enabled, footer enabled, close defaults true, ai_style Headers, main_menu Bottom, no_search Hidden
19. **Clipboard destructive ordering invariant** — 4 tests: unpinned last three destructive, pinned last three destructive, paste always first, copy always second
20. **Global actions always empty** — 1 test
21. **New chat action structure** — 7 tests: empty inputs→empty, last_used ID pattern, preset ID pattern, model ID pattern, section ordering, bolt icon, settings icon
22. **format_shortcut_hint additional** — 6 tests: opt→⌥, triple modifier, space, tab, arrowup, arrowdown
23. **Agent context actions** — 5 tests: "Edit Agent" title, no view_logs, has copy_content, has reveal+copy_path, description mentions "agent"
24. **Cross-context ID uniqueness** — 6 tests: script, clipboard, AI, path, notes, file
25. **has_action=false invariant** — 6 tests: script, clipboard, AI, path, file, notes
26. **Ordering determinism** — 5 tests: script, clipboard, AI, notes, path
27. **Action builder chaining** — 3 tests: with_icon preserves shortcut, with_section preserves icon, full chain
28. **Note switcher description rendering** — 6 tests: preview+time separator, empty uses char count, singular char, truncation at 61, no truncation at 60, empty preview with time
29. **File context title** — 3 tests: includes filename, dir includes dirname, has quotes
30. **Non-empty id and title** — 6 tests: script, clipboard, AI, path, notes, file

## Verification

- `cargo check --lib` pass
- `cargo clippy --lib -- -D warnings` pass
- `cargo test --lib actions::dialog_builtin_action_validation_tests_14` 169 passed, 0 failed
- `git push` pass

## What to Avoid Repeating

- **`CommandBarConfig` is in `command_bar.rs`**: Import via `super::super::command_bar::CommandBarConfig`, not from `types.rs`.
- **Pre-existing bin compilation errors** in `ai/window.rs` from concurrent agents. Use `cargo check --lib` / `cargo clippy --lib` to avoid.
- **`cargo fmt` in pre-commit hook formats ALL modified files**: Restore concurrent agent files with `git checkout HEAD -- <file>` before committing.
- **Temporary value lifetime issues (E0716)**: Pattern `action_ids(&get_*_actions(...))` creates temps freed too early. Bind Vec to a variable first.
- **`for action in &get_*_actions(...)` is OK** — Rust extends the temporary lifetime for the for-loop duration.
- **`to_deeplink_name` preserves Unicode alphanumeric characters** (CJK, accented). Don't assume they get stripped.
- **File context `copy_filename` shortcut is `⌘C`** in file context, but path context `copy_filename` has no shortcut.
