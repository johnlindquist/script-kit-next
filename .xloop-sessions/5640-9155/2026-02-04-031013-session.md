# Session: Batch 15 Builtin Action Validation Tests

**Date**: 2026-02-04
**Commit**: 04d7f90
**Branch**: main

## Summary

Created batch 15 of dialog builtin action validation tests with **147 tests** across **30 categories**, continuing the series from batches 1-14.

## Files Changed

- `src/actions/dialog_builtin_action_validation_tests_15.rs` (new, ~2056 lines) — 147 tests in 30 categories
- `src/actions/mod.rs` (+4 lines: test module registration for batch 15)

## What Was Improved

### New Tests (147 across 30 categories):

1. **to_deeplink_name with non-Latin Unicode** — 7 tests: Arabic preserved, Thai preserved, Devanagari preserved, mixed scripts, empty string, only-specials→empty, single char
2. **Clipboard image macOS-exclusive actions** — 5 tests (cfg(target_os="macos")): open_with, annotate_cleanshot, upload_cleanshot present for images; text lacks annotate/upload; image has OCR text does not
3. **Notes combined-flag interactions** — 5 tests: all-true trash blocks selection actions, no-selection no-trash, full feature set=10, auto_sizing hides action (9), trash minimal=2
4. **Chat context boundary states** — 6 tests: zero models both flags false=1 action, zero models both flags true=3, model ID format select_model_{id}, current model checkmark, continue shortcut ⌘↵, description "via {provider}"
5. **New chat section ordering guarantees** — 6 tests: empty all→empty, section ordering Last Used/Presets/Models, preset no description, model has provider description, last_used BoltFilled icon, model Settings icon
6. **Note switcher description fallback hierarchy** — 8 tests: preview+time with separator, preview no time, no preview with time, no preview no time→char count, singular "1 char", zero "0 chars", exactly 60 no ellipsis, 61 has ellipsis
7. **AI command bar per-section ID enumeration** — 6 tests: Response=[copy_response, copy_chat, copy_last_code], Actions=[submit, new_chat, delete_chat, branch_from_last], Attachments=[add_attachment, paste_image], Export=[export_markdown], Help=[toggle_shortcuts_help], Settings=[change_model]
8. **Action builder overwrite semantics** — 5 tests: with_shortcut overwrites, with_icon overwrites, with_section overwrites, with_shortcut_opt(None) preserves existing, with_shortcut_opt(Some) sets
9. **CommandBarConfig preset field comparison matrix** — 6 tests: default vs ai_style section_style, notes search Top, no_search Hidden, main_menu Bottom, all presets close_on_select true, all presets close_on_escape true
10. **Cross-context category uniformity** — 6 tests: script, clipboard, AI, path, notes, chat all ActionCategory::ScriptContext
11. **Clipboard exact action counts on macOS** — 3 tests (cfg(target_os="macos")): text=12, image=16, image>text
12. **Path primary-action insertion position** — 4 tests: dir primary first=open_directory, file primary first=select_file, move_to_trash always last, dir/file same count
13. **File title quoting** — 4 tests: file title contains "filename", dir title contains "dirname", file primary=open_file, dir primary=open_directory
14. **ScriptInfo::with_all field completeness** — 5 tests: name/path, is_script toggle, verb, shortcut+alias, no agent/scriptlet/suggested
15. **Script context run title includes verb+name** — 3 tests: default "Run" verb, custom "Switch to" verb, builtin title
16. **Ordering idempotency** — 5 tests: script, clipboard, AI, notes, path all deterministic on double-call
17. **Note switcher icon hierarchy** — 4 tests: pinned overrides current→StarFilled, current only→Check, regular→File, pinned not current→StarFilled
18. **Note switcher section assignment** — 4 tests: pinned→"Pinned", unpinned→"Recent", mixed sections, empty→"Notes"
19. **Note switcher current bullet prefix** — 3 tests: current has "• ", non-current no bullet, current+pinned has bullet
20. **Clipboard paste title dynamic behavior** — 4 tests: no app→"Active App", with app→name, Unicode app, empty string app
21. **Clipboard pin/unpin toggle** — 3 tests: unpinned shows pin, pinned shows unpin, pin/unpin share same shortcut ⇧⌘P
22. **Clipboard destructive actions always last three** — 4 tests: text last three destructive, image last three destructive, paste always first, copy always second
23. **Action lowercase caching** — 6 tests: title_lower, description_lower, description None→None, shortcut_lower None initially, set after with_shortcut, Unicode lowercase
24. **AI command bar total count and icons** — 5 tests: total=12, all have icons, all have sections, 6 unique sections, IDs unique
25. **Notes format action shortcut and icon** — 3 tests: shortcut ⇧⌘T, icon Code, section Edit
26. **File context common actions** — 5 tests: file has reveal, copy_path, copy_filename; dir has reveal, copy_path
27. **Script context shortcut/alias dynamic count** — 4 tests: no-shortcut/no-alias=9, +shortcut=10, +both=11, +frecency adds 1
28. **has_action=false invariant** — 6 tests: script, clipboard, AI, path, notes, file all false
29. **ID uniqueness across contexts** — 6 tests: script, clipboard, path, file, notes, note_switcher IDs unique
30. **Non-empty id and title invariant** — 6 tests: script, clipboard, AI, path, notes, file

## Verification

- `cargo check --lib` pass
- `cargo clippy --lib -- -D warnings` pass
- `cargo test --lib actions::dialog_builtin_action_validation_tests_15` 147 passed, 0 failed
- `git push` pass

## What to Avoid Repeating

- **CommandBarConfig fields are nested under `dialog_config`**: Access via `config.dialog_config.search_position`, not `config.search_position`.
- **`with_shortcut_opt(None)` does NOT clear an existing shortcut**: It preserves the previous value (likely `Option::or` semantics).
- **Path context trash action ID is `move_to_trash`**, not `trash`.
- **Pre-existing bin compilation errors** in `ai/window.rs` from concurrent agents. Use `cargo check --lib` / `cargo clippy --lib` to avoid.
- **`cargo fmt` in pre-commit hook formats ALL modified files**: Restore concurrent agent files with `git checkout HEAD -- <file>` before committing if needed.
- **Temporary value lifetime issues (E0716)**: Bind `get_*_actions()` Vec to a variable before borrowing (e.g., for `HashSet<&str>` collection).
- **`for action in &get_*_actions(...)` is OK** — Rust extends the temporary lifetime for the for-loop duration.
- **`to_deeplink_name` preserves Unicode alphanumeric characters** (Arabic, Thai, Devanagari, CJK, accented). Don't assume they get stripped.
