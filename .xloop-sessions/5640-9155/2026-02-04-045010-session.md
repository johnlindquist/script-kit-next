# Session: Batch 27 Builtin Action Validation Tests

**Date**: 2026-02-04
**Commit**: d6cb75e
**Branch**: main

## Summary

Created batch 27 of dialog builtin action validation tests with **118 tests** across **30 categories**, continuing the series from batches 1-26.

## Files Changed

- `src/actions/dialog_builtin_action_validation_tests_27.rs` (new, ~1412 lines) — 118 tests in 30 categories
- `src/actions/mod.rs` (+4 lines: test module registration for batch 27)

## What Was Improved

### New Tests (118 across 30 categories):

1. **Clipboard: frontmost_app_name dynamic paste title** — 4 tests: with app name, without app name, long name, ID is clipboard_paste
2. **Scriptlet context: edit_scriptlet desc mentions markdown** — 4 tests: edit desc mentions markdown, reveal desc mentions bundle, copy_scriptlet_path ID, has copy_content
3. **Script context: agent action count and ordering** — 4 tests: 8 actions no shortcut/alias, first=run_script, last=copy_deeplink, suggested adds reset_ranking
4. **Notes command bar: auto_sizing action conditionality** — 4 tests: absent when enabled, present when disabled, shortcut ⌘A, icon Settings
5. **AI command bar: paste_image details** — 4 tests: shortcut ⌘V, section Attachments, icon File, desc mentions clipboard
6. **Chat context: zero models and combo counts** — 4 tests: 0 models no flags=1, 1 model both flags=4, 3 models no flags=4, response without messages=2
7. **New chat: ID patterns and sections** — 4 tests: model_0 prefix, Models section, preset_id prefix, last_used_0 prefix
8. **Note switcher: empty preview+empty time→char count** — 4 tests: shows "42 chars", empty preview with time shows time only, singular "1 char", "0 chars"
9. **File context: copy_filename vs copy_path shortcut** — 3 tests: copy_filename=⌘C, copy_path=⌘⇧C, dir copy_filename also ⌘C
10. **Path context: copy_filename has no shortcut** — 3 tests: file no shortcut, copy_path has ⌘⇧C, dir copy_filename still no shortcut
11. **format_shortcut_hint: intermediate modifier handling** — 5 tests: cmd+shift+c, ctrl+alt+delete, single enter, super alias, option+space
12. **to_deeplink_name: mixed punctuation collapses** — 4 tests: dots, parens/brackets, ampersand/at, slash/backslash
13. **score_action: fuzzy bonus value** — 4 tests: fuzzy=25, prefix≥100, contains≥50, no match=0
14. **build_grouped_items_static: None section in Headers mode** — 4 tests: no section skips header, with section adds header, two sections two headers, separators never adds headers
15. **CommandBarConfig: notes_style uses Separators** — 4 tests: notes=Separators, ai=Headers, main_menu=Separators, no_search=Hidden
16. **Cross-context: first action shortcut is ↵** — 4 tests: script, clipboard, path, file all have ↵ as first shortcut
17. **Clipboard: image vs text OCR difference** — 3 tests: image has OCR, text no OCR, image more actions than text
18. **coerce_action_selection: item/header patterns** — 4 tests: all items stays, beyond len clamps, header at 0 jumps, only headers=None
19. **Action: with_shortcut sets shortcut_lower** — 4 tests: sets lowercase, no shortcut=None, title_lower precomputed, description_lower precomputed
20. **Script context: scriptlet vs script edit IDs** — 4 tests: script=edit_script, scriptlet=edit_scriptlet, agent=edit_script, agent title says Agent
21. **Notes command bar: copy section conditionality** — 4 tests: present with selection, absent without selection, absent in trash, quicklink shortcut ⇧⌘L
22. **AI command bar: section counts** — 4 tests: Response=3, Actions=4, Attachments=2, total=12
23. **parse_shortcut_keycaps: various combos** — 4 tests: ⌘E, all modifiers+key, enter alone, lowercase uppercased
24. **fuzzy_match: various patterns** — 5 tests: exact, subsequence, no match, empty needle, needle longer fails
25. **Script context: view_logs exclusive to is_script** — 4 tests: script has, scriptlet no, builtin no, agent no
26. **Clipboard: delete action descriptions** — 3 tests: delete_all mentions pinned, delete_multiple mentions filter, delete shortcut ⌃X
27. **Note switcher: preview with time separator** — 3 tests: has " · " separator, long preview truncated, exactly 60 no truncation
28. **ScriptInfo: with_frecency builder chain** — 3 tests: sets is_suggested, false not suggested, preserves other fields
29. **CommandBarConfig: anchor positions** — 4 tests: default=Bottom, ai=Top, main_menu=Bottom, notes=Top
30. **Cross-context: all action IDs non-empty** — 6 tests: script, clipboard, AI, path, file, notes all have non-empty IDs

## Verification

- `cargo check --lib` pass
- `cargo clippy --lib -- -D warnings` pass
- `cargo test --lib actions::dialog_builtin_action_validation_tests_27` 118 passed, 0 failed
- `git push` pass

## What to Avoid Repeating

- **Pre-existing bin compilation errors** in `ai/window.rs` from concurrent agents. Use `cargo check --lib` / `cargo clippy --lib` to avoid.
- **`cargo fmt` in pre-commit hook formats ALL modified files**: Run `cargo fmt` before committing.
- **Clipboard paste title is dynamic**: With `frontmost_app_name: Some("Safari")` → "Paste to Safari", with `None` → "Paste to Active App".
- **Path context `copy_filename` has NO shortcut**, unlike file context where `copy_filename` has `⌘C`.
- **Agent has 8 actions** (no shortcut/alias): run_script, add_shortcut, add_alias, edit_script(Agent), reveal, copy_path, copy_content, copy_deeplink.
- **Notes `enable_auto_sizing` only appears when `auto_sizing_enabled=false`** — it's absent when already enabled.
- **Chat context with 0 models, no flags produces exactly 1 action** (continue_in_chat). Adding `has_response` adds copy_response, `has_messages` adds clear_conversation.
- **New chat model IDs use `model_{idx}` format**, last_used use `last_used_{idx}`, presets use `preset_{id}`.
- **Note switcher with empty preview AND empty time** falls back to "{char_count} char(s)" format.
- **`to_deeplink_name` collapses all non-alphanumeric characters** (dots, parens, slashes, etc.) into single hyphens.
- **CommandBarConfig notes_style uses SectionStyle::Separators** (not Headers), while ai_style uses Headers.
- **All contexts have ↵ as the first action's shortcut** (run_script, clipboard_paste, primary path/file action).
