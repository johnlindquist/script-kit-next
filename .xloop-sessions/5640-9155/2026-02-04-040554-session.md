# Session: Batch 21 Builtin Action Validation Tests

**Date**: 2026-02-04
**Commit**: fb86bd4
**Branch**: main

## Summary

Created batch 21 of dialog builtin action validation tests with **135 tests** across **30 categories**, continuing the series from batches 1-20.

## Files Changed

- `src/actions/dialog_builtin_action_validation_tests_21.rs` (new, ~1634 lines) — 135 tests in 30 categories
- `src/actions/mod.rs` (+4 lines: test module registration for batch 21)

## What Was Improved

### New Tests (135 across 30 categories):

1. **Script context: is_script/is_scriptlet/is_agent mutually exclusive** — 5 tests: script has view_logs, scriptlet/agent/builtin don't, edit title differs
2. **Script context: run_script always first** — 5 tests: script, builtin, scriptlet, agent, scriptlet_with_custom all have run_script at index 0
3. **File context: title format includes quoted name** — 4 tests: file/dir title contains quoted name, starts with "Open"
4. **Path context: dir primary=open_directory, file primary=select_file** — 5 tests: dir/file primary IDs, titles contain name, same action count
5. **AI command bar: total and section counts** — 5 tests: total=12, Response=3, Actions=4, Attachments=2, Export=1
6. **AI command bar: copy_chat and copy_last_code details** — 5 tests: shortcuts ⌥⇧⌘C/⌥⌘C, icons Copy/Code, section Response
7. **AI command bar: paste_image details** — 4 tests: shortcut ⌘V, icon File, section Attachments, add_attachment ⇧⌘A
8. **AI command bar: toggle_shortcuts_help details** — 5 tests: shortcut ⌘/, icon Star, section Help, change_model/branch_from_last no shortcut
9. **Chat context: clear_conversation conditional** — 4 tests: absent no messages, present with messages, shortcut ⌘⌫, copy_response ⌘C
10. **Chat context: continue_in_chat ordering** — 3 tests: after models, present with 0 models, shortcut ⌘↵
11. **Notes command bar: copy section actions** — 5 tests: copy_deeplink ⇧⌘D in Copy, create_quicklink ⇧⌘L with Star, copy_note_as ⇧⌘C
12. **Notes command bar: enable_auto_sizing conditional** — 4 tests: absent when enabled, present when disabled, shortcut ⌘A, section Settings
13. **Note switcher: relative_time propagation** — 5 tests: preview+time joined with " · ", no time no separator, no preview falls back to char count, singular "char"
14. **New chat actions: ID format patterns** — 5 tests: last_used_0, preset_{id}, model_0, sequential IDs, empty→empty
15. **Clipboard context: description content** — 4 tests: copy/paste mention clipboard, paste_keep_open mentions keep, delete_all mentions pinned
16. **Clipboard context: frontmost_app_name edge cases** — 2 tests: empty string app, Unicode app name
17. **CommandBarConfig preset field matrix** — 5 tests: default Bottom, ai Top anchor, main_menu Bottom anchor, notes icons/footer true
18. **ActionsDialogConfig default values** — 5 tests: search Bottom, section Separators, anchor Bottom, no icons, no footer
19. **Action with_shortcut caching behavior** — 5 tests: shortcut_lower set, no shortcut none, title_lower precomputed, description_lower precomputed/none
20. **Action builder chaining** — 5 tests: with_icon preserves shortcut, with_section preserves icon, full chain, with_shortcut_opt(None) preserves, with_shortcut_opt(Some) sets
21. **build_grouped_items_static section transitions** — 4 tests: two sections=4 items, same section no dup, separators no headers, empty→empty
22. **coerce_action_selection header skipping** — 5 tests: on item stays, header→down, trailing header→up, all headers None, empty None
23. **ScriptInfo constructor defaults** — 4 tests: new defaults, builtin empty path, scriptlet flags, with_frecency chaining
24. **Script context: copy_content shortcut consistent** — 4 tests: script/scriptlet/agent/scriptlet_with_custom all have ⌘⌥C
25. **File vs path context: primary action IDs differ** — 3 tests: file=open_file, path=select_file, dir same ID both contexts
26. **Path context: move_to_trash always last** — 4 tests: last for dir/file, description says "folder"/"file"
27. **Cross-context: all built-in IDs are snake_case** — 6 tests: script, builtin, scriptlet, clipboard, ai, notes
28. **Cross-context: non-empty IDs and titles** — 4 tests: script, clipboard_image, path, file
29. **Script context: deeplink description URL format** — 3 tests: script, builtin, scriptlet all contain scriptkit://run/{name}
30. **Cross-context: ID uniqueness** — 8 tests: script, script_full, clipboard_text, clipboard_image, ai, notes, path_dir, path_file

## Verification

- `cargo check --lib` pass
- `cargo clippy --lib -- -D warnings` pass
- `cargo test --lib actions::dialog_builtin_action_validation_tests_21` 135 passed, 0 failed
- `git push` pass

## What to Avoid Repeating

- **Pre-existing bin compilation errors** in `ai/window.rs` from concurrent agents. Use `cargo check --lib` / `cargo clippy --lib` to avoid.
- **`cargo fmt` in pre-commit hook formats ALL modified files**: Run `cargo fmt` before committing.
- **Duplicate test function names cause E0428**: When reusing similar test patterns across categories, ensure unique function names.
- **Agent context uses `edit_script` as the action ID** but title is "Edit Agent".
- **`with_shortcut_opt(None)` does NOT clear an existing shortcut**: It preserves the previous value.
- **Path context `copy_filename` has NO shortcut**, unlike file context where `copy_filename` has `⌘C`.
- **File context primary for files is `open_file`**, path context primary for files is `select_file`.
- **Clipboard paste title with empty string app produces "Paste to "** (with trailing space).
- **All built-in action IDs use snake_case** — no spaces, no hyphens.
