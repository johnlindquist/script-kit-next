# Session: Batch 37 Builtin Action Validation Tests

**Date**: 2026-02-04
**Commit**: a5ebd98
**Branch**: main

## Summary

Created batch 37 of dialog builtin action validation tests with **120 tests** across **30 categories**, continuing the series from batches 1-36.

## Files Changed

- `src/actions/dialog_builtin_action_validation_tests_37.rs` (new, ~1505 lines) — 120 tests in 30 categories
- `src/actions/mod.rs` (+4 lines: test module registration for batch 37)

## What Was Improved

### New Tests (120 across 30 categories):

1. **Clipboard context_title truncation: >30 chars truncated with "..."** — 4 tests: short not truncated, exactly 30 not truncated, 31 chars truncated, long truncated at byte 27
2. **Chat context_title fallback when current_model is None** — 4 tests: with model name, fallback to "Chat", empty string not fallback, no model produces only continue_in_chat
3. **ScriptletAction action_id() prefix format** — 4 tests: uses "scriptlet_action:" prefix, uses command not name, propagates has_action=true, shortcut formatted
4. **Path context: copy_filename has NO shortcut** — 4 tests: path has no shortcut, file has shortcut, differs between path/file, desc says "just the filename"
5. **File context: show_info (Get Info) details on macOS** — 4 tests: shortcut ⌘I, title "Get Info", desc mentions Finder, present for dirs
6. **Notes command bar: section distribution across conditions** — 4 tests: no selection/no trash/disabled auto=3, enabled auto=2, trash=3, full section distribution
7. **Clipboard: paste_and_keep_open details** — 4 tests: shortcut ⌥↵, title, desc mentions keep, is third action
8. **AI command bar: add_attachment details** — 4 tests: shortcut ⇧⌘A, icon Plus, section Attachments, desc mentions attach
9. **ScriptInfo constructors: is_agent field defaults** — 4 tests: new false, builtin false, scriptlet false, with_all false
10. **Deeplink URL in copy_deeplink desc** — 4 tests: script URL, scriptlet URL, builtin URL, agent URL
11. **to_deeplink_name: CJK and multi-byte unicode** — 4 tests: CJK preserved, mixed CJK+spaces, accented chars, consecutive special collapse
12. **Score action: exact values for fuzzy=25, contains=50, prefix=100** — 4 tests: prefix exactly 100, contains exactly 50, fuzzy exactly 25, desc bonus exactly 15
13. **Notes: create_quicklink and copy_deeplink details** — 4 tests: quicklink shortcut ⇧⌘L, quicklink icon Star, deeplink shortcut ⇧⌘D, deeplink icon ArrowRight
14. **Scriptlet context with_custom: copy_deeplink URL format** — 4 tests: URL format, reset_ranking when suggested, no reset_ranking default, edit_scriptlet desc
15. **ProtocolAction: new() constructor defaults** — 4 tests: description None, shortcut None, visible None (is_visible=true), close None (should_close=true)
16. **Clipboard: delete_multiple and delete_all details** — 4 tests: delete_multiple ⇧⌘X, delete_all ⌃⇧X, delete_all desc mentions pinned, delete_multiple title
17. **AI bar: Actions section has exactly 4 actions** — 4 tests: section count=4, section IDs, Response count=3, unique sections=6
18. **CommandBarConfig: notes_style vs ai_style differences** — 4 tests: notes=Separators, ai=Headers, both search_top, both anchor_top
19. **File context: open_with on macOS details** — 4 tests: shortcut ⌘O, title "Open With...", desc mentions application, present for dirs
20. **build_grouped_items_static: non-consecutive same-section** — 4 tests: non-consecutive creates two headers, consecutive one header, Separators no headers, None no headers
21. **Action::new defaults: has_action, value, icon, section** — 4 tests: has_action false, value None, icon None, section None
22. **Cross-context: scriptlet vs script shortcut action IDs differ** — 4 tests: script has edit_script, scriptlet has edit_scriptlet, script has reveal_in_finder, scriptlet has reveal_scriptlet_in_finder
23. **New chat: duplicate model entries produce distinct IDs** — 4 tests: duplicate models distinct IDs, model IDs use index not model_id, preset IDs use preset.id, last_used IDs use index
24. **Note switcher: description formatting for all branches** — 4 tests: preview+time has separator, preview only no separator, time only when empty preview, char count when no preview no time
25. **Clipboard: image has all 4 macOS-only image actions** — 4 tests: open_with, annotate_cleanshot, upload_cleanshot, ocr
26. **Score action: exact full title match** — 4 tests: exact=prefix(100), shortcut bonus=10, no match=0, prefix+desc=115
27. **Path context: copy_filename has no shortcut (unlike file)** — 4 tests: dir also no shortcut, copy_path has shortcut, open_in_finder has shortcut, open_in_editor has shortcut
28. **Cross-context: all contexts set category to ScriptContext** — 4 tests: script, file, path, AI bar
29. **format_shortcut_hint: various conversions** — 4 tests: single letter, cmd+letter, all four modifiers, meta alias
30. **parse_shortcut_keycaps: various inputs** — 4 tests: modifier+letter, all modifiers+key, return symbol, lowercase uppercased

## Verification

- `cargo check --lib` pass
- `cargo clippy --lib -- -D warnings` pass
- `RUST_MIN_STACK=67108864 cargo test --lib actions::dialog_builtin_action_validation_tests_37` 120 passed, 0 failed
- `git push` pass

## What to Avoid Repeating

- **Clipboard context_title truncation uses byte slicing `&preview[..27]`**, not character slicing. For ASCII text this is the same, but for multi-byte unicode it could panic. The truncation boundary is 30 bytes total (27 content + "...").
- **Path context `copy_filename` has NO shortcut** while file context `copy_filename` has `⌘C`. This is an intentional difference between the two contexts.
- **File context `show_info` (Get Info)** is macOS-only, shortcut `⌘I`, present for both files and directories.
- **Notes no selection + no trash + enabled auto-sizing = 2 actions** (new_note, browse_notes). With disabled auto-sizing = 3.
- **Chat context with no models and no messages/response = 1 action** (only continue_in_chat).
- **ScriptletAction::action_id()** uses `"scriptlet_action:" + command`, where command is the slugified name, NOT the name itself.
- **`to_deeplink_name` preserves CJK characters** because `char::is_alphanumeric()` returns true for them.
- **`score_action` exact values**: prefix=100, contains=50, fuzzy=25, desc bonus=15, shortcut bonus=10.
- **`build_grouped_items_static` with non-consecutive same-section and Headers style creates TWO headers** for the same section name. It only deduplicates consecutive sections.
- **New chat model IDs use `model_{index}` format**, not `model_{model_id}`. So duplicate model entries produce distinct action IDs.
- **All ScriptInfo constructors set `is_agent: false`** by default. To create agent actions, manually set `is_agent = true` after construction.
