# Session: Batch 20 Builtin Action Validation Tests

**Date**: 2026-02-04
**Commit**: 6927a60
**Branch**: main

## Summary

Created batch 20 of dialog builtin action validation tests with **146 tests** across **30 categories**, continuing the series from batches 1-19.

## Files Changed

- `src/actions/dialog_builtin_action_validation_tests_20.rs` (new, ~1796 lines) — 146 tests in 30 categories
- `src/actions/mod.rs` (+4 lines: test module registration for batch 20)

## What Was Improved

### New Tests (146 across 30 categories):

1. **Script vs agent edit action description difference** — 4 tests: script edit mentions $EDITOR, agent edit mentions "agent", agent title "Edit Agent", script title "Edit Script"
2. **Scriptlet context copy_content presence and details** — 4 tests: present in get_script_context_actions, present in get_scriptlet_context_actions_with_custom, shortcut ⌘⌥C, description mentions "file"
3. **Path context open title includes quoted name** — 5 tests: dir title includes name, file title includes name, dir primary=open_directory, file primary=select_file, file context title includes name
4. **Clipboard destructive action descriptions and ordering** — 4 tests: delete_all mentions "pinned", delete mentions "remove", delete_multiple mentions "filter"/"entries", destructive ordering preserved
5. **AI command bar shortcut presence/absence** — 5 tests: branch_from_last no shortcut, change_model no shortcut, submit=↵, new_chat=⌘N, delete_chat=⌘⌫
6. **Notes command bar new_note/browse_notes always present** — 5 tests: new_note in full, new_note in trash, browse_notes always, new_note shortcut ⌘N, browse_notes icon FolderOpen
7. **Chat context model ordering and checkmarks** — 4 tests: model ordering preserved, continue after models, current model checkmark ✓, description "via {provider}"
8. **New chat section icons and names** — 6 tests: last_used BoltFilled, last_used "Last Used Settings", model "Models", model Settings icon, preset "Presets", preset icon preserved
9. **Note switcher description format** — 5 tests: preview+time with " · ", no preview→char count, singular "1 char", preview only, time only
10. **to_deeplink_name CJK and accented preservation** — 5 tests: CJK preserved, accented preserved, mixed case lowered, mixed specials, empty string
11. **Action::new pre-computed lowercase fields** — 5 tests: title_lower, description_lower, description None, shortcut_lower None initially, shortcut_lower after with_shortcut
12. **score_action scoring tiers via ActionsDialog** — 5 tests: prefix=100, contains=50, no match=0, desc bonus≥15, shortcut bonus≥10
13. **fuzzy_match subsequence behavior** — 7 tests: exact, subsequence, no match, empty needle, empty haystack, both empty, needle longer
14. **parse_shortcut_keycaps splitting** — 5 tests: ⌘C=2 caps, ⌘⇧C=3 caps, ↵ single, arrows=4, ⎋ single
15. **build_grouped_items_static section headers** — 5 tests: Headers adds headers, same section no dup, Separators no headers, empty→empty, None no headers
16. **coerce_action_selection header skipping** — 5 tests: item stays, header→down, trailing header→up, all headers→None, empty→None
17. **CommandBarConfig preset field matrix** — 5 tests: default close, ai_style Top, main_menu Bottom, no_search Hidden, notes_style Separators+icons+footer
18. **Action builder with_shortcut_opt behavior** — 4 tests: None preserves existing, Some sets, with_icon preserves shortcut, with_section preserves all
19. **ScriptInfo with_is_script vs with_action_verb** — 4 tests: with_is_script true, with_is_script false, with_action_verb custom, with_action_verb_and_shortcut
20. **Notes command bar conditional actions per flags** — 5 tests: duplicate_note requires selection+no trash, find_in_note absent in trash, export requires selection+no trash, auto_sizing absent when enabled, present when disabled
21. **Clipboard share/attach_to_ai universality** — 5 tests: text has share, image has share, text has attach_to_ai, image has attach_to_ai, share shortcut ⇧⌘E
22. **File context directory lacks quick_look (macOS)** — 4 tests: dir no quick_look, file has quick_look, dir has open_with, dir has show_info
23. **Scriptlet defined actions from H3 headers** — 5 tests: empty scriptlet no actions, single action has_action=true, ID prefix "scriptlet_action:", value=command, shortcut formatted ⌘C
24. **Script context run_script title includes action_verb** — 4 tests: default "Run", custom "Launch", "Switch to", title contains quoted name
25. **Notes command bar section assignments** — 5 tests: new_note→"Notes", find_in_note→"Edit", format→"Edit", copy_note_as→"Copy", export→"Export"
26. **AI command bar icon assignments** — 5 tests: copy_response=Copy, submit=ArrowUp, new_chat=Plus, delete_chat=Trash, export_markdown=FileCode
27. **Note switcher icon priority hierarchy** — 4 tests: pinned→StarFilled, current→Check, regular→File, pinned+current→StarFilled
28. **Note switcher empty state placeholder** — 5 tests: single placeholder, id="no_notes", title="No notes yet", icon=Plus, section="Notes"
29. **Cross-context all descriptions non-empty** — 6 tests: script, clipboard, AI, path, file, notes all have descriptions
30. **Cross-context ID uniqueness and snake_case** — 6 tests: script IDs unique, clipboard IDs unique, AI IDs unique, path IDs unique, builtin IDs snake_case, notes IDs unique

## Verification

- `cargo check --lib` pass
- `cargo clippy --lib -- -D warnings` pass
- `cargo test --lib actions::dialog_builtin_action_validation_tests_20` 146 passed, 0 failed
- `git push` pass

## What to Avoid Repeating

- **Pre-existing bin compilation errors** in `ai/window.rs` from concurrent agents. Use `cargo check --lib` / `cargo clippy --lib` to avoid.
- **`cargo fmt` in pre-commit hook formats ALL modified files**: Run `cargo fmt` before committing.
- **Agent context uses `edit_script` as the action ID** but title is "Edit Agent" and description mentions "agent".
- **`with_shortcut_opt(None)` does NOT clear an existing shortcut**: It preserves the previous value.
- **`CommandBarConfig` fields are nested under `dialog_config`**: Access via `config.dialog_config.search_position`.
- **Note switcher empty state returns a single placeholder action** with id="no_notes", icon=Plus, section="Notes".
- **Scriptlet defined actions always have `has_action=true`** and ID prefix `scriptlet_action:`.
- **`to_deeplink_name` preserves Unicode alphanumeric characters** (CJK, accented).
- **Builtin action IDs use snake_case** — no spaces, no hyphens.
- **All action builder functions produce actions with non-empty descriptions** across all contexts.
