# xpolish session: AI Chat Window Design Tokens & Contrast

**Commit:** `ca772c3` — `[xpolish] refactor: extract hardcoded values to design tokens in AI chat window`

## Files Changed

| File | Lines Changed | Summary |
|------|--------------|---------|
| `src/ai/window.rs` | +214 / -146 | Added 30+ design token constants; replaced ~100 inline magic numbers with tokens across 8 render functions |
| `src/prompts/chat.rs` | +3 / -3 | Fixed `gpui::white()` → `cx.theme().accent_foreground`; replaced `text_size(px(14.0))` → `text_sm()` |

## What Was Improved

### Design Token Extraction (window.rs)
- **Spacing scale:** 10 constants (`SP_1`–`SP_10`) on 4px micro-steps / 8pt grid
- **Border radii:** 4 constants (`RADIUS_XS`–`RADIUS_LG`)
- **Icon sizes:** 3 constants (`ICON_XS`=12, `ICON_SM`=14, `ICON_MD`=16)
- **Layout:** `SIDEBAR_W`=240, `TITLEBAR_H`=36
- **Message bubble:** `MSG_PX`, `MSG_PY`, `MSG_RADIUS`, `MSG_GAP`, `MSG_GAP_CONTINUATION`
- **Semantic opacities:** 5 levels (`OP_SUBTLE`=0.15, `OP_MUTED`=0.3, `OP_MEDIUM`=0.5, `OP_STRONG`=0.7, `OP_NEAR_FULL`=0.85)
- **Dot separator:** `DOT_SIZE`=3px

### Hard-Coded Color Fixes
- Modal overlay: `0x00000080`/`0xffffff80` → theme-derived `0x0B122080`/`0xF8FAFC80`
- Remove hover: `gpui::red()` → `theme.danger`
- Setup card buttons: `gpui::white()` → `cx.theme().accent_foreground` (2 instances)

### Contrast Tuning
- User message bg opacity: 0.15 → 0.12 (less tint for readability)
- Assistant message bg opacity: 0.15 → 0.10 (subtler)
- User message border opacity: 0.5 → 0.45 (softer left-bar)
- Role label icon opacity: 0.7 → `OP_STRONG` (0.7, unchanged but named)
- Role label text opacity: 0.85 → `OP_NEAR_FULL` (0.85, unchanged but named)
- Timestamp opacity: 0.55 → `OP_MEDIUM` (0.5, slightly reduced for consistency)

### Render Functions Updated
`render_message`, `render_streaming_content`, `render_streaming_error`, `render_message_actions`, `render_sidebar`, `render_main_panel`, `render_search`, `render_messages` (scroll pill)

## What To Avoid Repeating

1. **AI window screenshots are hard to automate.** The separate `Script Kit AI` window opens with 0x0 bounds in headless mode. Use the inline chat (`Tab` from main window) for automated visual testing, or existing reference screenshots in `test-screenshots/ai-window-scroll/`.
2. **`captureWindow` stdin command has a race condition.** The command is parsed on the listener thread but dispatched to the main thread via an async channel. If the pipe closes too quickly, the command never executes. Always add ≥3s sleep after `captureWindow` before closing the pipe.
3. **`rustfmt` standalone doesn't work** on files using GPUI's `async move |this, cx|` syntax. Use `cargo fmt` instead.
4. **Pre-existing clippy errors** exist in `render_script_list.rs` and test files (missing constant imports). These aren't related to AI chat changes.
5. **`px()` is const-compatible** in this codebase — safe to use in `const` declarations.
6. **Don't try to const-ify opacity floats per-component** — the semantic level approach (5 named levels) is cleaner than per-widget opacity tokens.
