## Oracle Security Audit: Frecency Scoring System

GPT-5.2 Pro completed a thorough security audit of `src/frecency/mod.rs`. Here are the **10 findings**, prioritized:

### Major (5 findings)

| # | Issue | Location | Fix |
|---|-------|----------|-----|
| **1** | **Unbounded file read + JSON parse → OOM/DoS** | `FrecencyStore::load` ~L240-269 | Add `MAX_FRECENCY_FILE_BYTES` (5 MiB) check on `metadata.len()` before reading; quarantine oversize files |
| **2** | **Malformed JSON "bricks" frecency permanently** | `FrecencyStore::load` ~L240-269 | Convert parse errors into quarantine-and-reset instead of propagating `Err` |
| **3** | **`score` field not skip-deserializing → easy parse-fail** | `FrecencyEntry` ~L22-32 | Add `#[serde(skip_deserializing)]` since score is derived and immediately recomputed on load |
| **4** | **Deterministic temp path enables symlink overwrite attack** | `FrecencyStore::save` ~L275-318 | Replace fixed `frecency.json.tmp` with `tempfile::NamedTempFile::new_in()` for O_EXCL semantics |
| **5** | **Default file permissions leak script paths** | `FrecencyStore::save` ~L275-318 | Set 0o600 permissions on the temp file before persist (Unix) |
| **6** | **No entry count cap → unbounded data inflation** | `record_use` ~L326-356 | Add `MAX_ENTRIES` (20K) and `MAX_KEY_BYTES` (1K) caps; evict oldest on overflow |

### Minor (4 findings)

| # | Issue | Location | Fix |
|---|-------|----------|-----|
| **7** | **No key validation → control chars in logs/UI** | `record_use` ~L326-356 | Add `normalize_key()` helper rejecting empty/overlong/control-char keys |
| **8** | **Future timestamps pin items at max score** | `score_at` ~L57-60, `load` ~L240-269 | Clamp `last_used` to `now + 24h` on load |
| **9** | **Integer overflow in prune helper** | `prune_stale_entries` ~L529-559 | Use `saturating_mul` for `min_age_days * SECONDS_PER_DAY` |
| **10** | **No fsync → power-loss can corrupt file** | `save` ~L275-318 | Call `sync_all()` on temp file before rename |

### Key positive finding
No **path traversal** risk — frecency keys are never used to construct filesystem paths. The only I/O target is `self.file_path`.

### NEXT_AREA
Audit the **script execution pipeline** — how scripts are launched, environment/argument handling, and built-in commands — for command injection, unsafe env var exposure, and filesystem permission assumptions.
