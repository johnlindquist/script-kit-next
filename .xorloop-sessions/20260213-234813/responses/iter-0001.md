Now I have a complete picture of all 5 call sites. Let me analyze the patterns and produce the swarm task list. Here's my analysis:

**Identical across arg, div, form (the "simple" prompts):**
- `toggle_predicate`: `|key, _key_char, modifiers| modifiers.platform && ui_foundation::is_key_k(key) && has_actions_for_handler`
- `on_toggle_actions`: `this.toggle_arg_actions(cx, window)` (with different log strings)
- `on_actions_dialog_execute`: `this.trigger_action_by_name(action_id, cx)`
- `allow_sdk_shortcuts`: `|_key, _key_char, _modifiers| true`
- `on_sdk_shortcut`: `this.trigger_action_by_name(&matched_shortcut.action_name, cx)` (with different log strings)
- `pre_handle`: `|_this, _event, _window, _cx| false`

**Different (editor, term):**
- Editor has a custom `pre_handle` (ScratchPadView ESC/Cmd+W), custom `allow_sdk_shortcuts` (reserved shortcut filtering), and richer logging
- Term has a custom `pre_handle` (escape blocking, QuickTerminalView ESC/Cmd+W, Cmd+K clear), custom `toggle_predicate` (Cmd+Shift+K), custom `on_actions_dialog_execute` (terminal action routing), and a custom `on_toggle_actions` (toggle_term_prompt_actions)

So arg, div, and form are nearly identical — they use the "default" behavior for all 6 closures. Editor and term have legitimately different logic. The fix is to provide a convenience constructor that supplies defaults for the common case, so arg/div/form don't need to spell out all 6 closures.

---

Here are the swarm tasks:

## SWARM TASK LIST

### Task 1: `add-default-preamble-helper`

**Scope:** `src/render_prompts/key_handler.rs`

**Task:**

In `src/render_prompts/key_handler.rs`, the `handle_prompt_key_preamble` function requires callers to pass 6 closure arguments (`pre_handle`, `toggle_predicate`, `on_toggle_actions`, `on_actions_dialog_execute`, `allow_sdk_shortcuts`, `on_sdk_shortcut`). Three of the five callers (arg, div, form) pass identical implementations for all 6 closures: `pre_handle` returns false, `toggle_predicate` checks `modifiers.platform && ui_foundation::is_key_k(key) && has_actions`, `on_toggle_actions` calls `this.toggle_arg_actions(cx, window)`, `on_actions_dialog_execute` calls `this.trigger_action_by_name(action_id, cx)`, `allow_sdk_shortcuts` returns true, and `on_sdk_shortcut` calls `this.trigger_action_by_name(&matched_shortcut.action_name, cx)`. The only difference is the log message string. Add a new convenience function that provides these defaults.

Add a new `pub(crate)` function called `handle_prompt_key_preamble_default` in the same file, right after the existing `handle_prompt_key_preamble` function. Its signature should be:

```rust
#[inline]
pub(crate) fn handle_prompt_key_preamble_default(
    app: &mut ScriptListApp,
    event: &gpui::KeyDownEvent,
    window: &mut Window,
    cx: &mut Context<ScriptListApp>,
    cfg: PromptKeyPreambleCfg,
    has_actions: bool,
    prompt_label: &'static str,
) -> bool
```

Inside, it should call `handle_prompt_key_preamble` with: `pre_handle` = `|_, _, _, _| false`, `toggle_predicate` = `|key, _, modifiers| modifiers.platform && ui_foundation::is_key_k(key) && has_actions`, `on_toggle_actions` = `|app, window, cx| { logging::log("KEY", &format!("Cmd+K in {prompt_label} - calling toggle_arg_actions")); app.toggle_arg_actions(cx, window); }`, `on_actions_dialog_execute` = `|app, action_id, cx| { app.trigger_action_by_name(action_id, cx); }`, `allow_sdk_shortcuts` = `|_, _, _| true`, `on_sdk_shortcut` = `|app, matched, cx| { logging::log("KEY", &format!("SDK action shortcut matched in {prompt_label}: {}", matched.action_name)); app.trigger_action_by_name(&matched.action_name, cx); }`.

Do NOT modify any other files. Do NOT change the existing `handle_prompt_key_preamble` function. The new function must compile alongside the existing one. Verify with `cargo check && cargo clippy --all-targets -- -D warnings`. Use `tracing` if the rest of the file uses it, but based on the existing code it uses `logging::log` — match that pattern exactly.

### Task 2: `simplify-arg-div-form-preamble`

**Scope:** `src/render_prompts/arg/render.rs, src/render_prompts/div.rs, src/render_prompts/form/render.rs`

**Task:**

After Task 1 adds `handle_prompt_key_preamble_default`, replace the verbose 6-closure calls in arg, div, and form with calls to the new helper. In `src/render_prompts/arg/render.rs` (lines ~114-147), the call to `handle_prompt_key_preamble(this, event, window, cx, PromptKeyPreambleCfg { is_dismissable: true, stop_propagation_on_global_shortcut: false, stop_propagation_when_handled: false, host: ActionsDialogHost::ArgPrompt }, |_this, _event, _window, _cx| false, |key, _key_char, modifiers| { modifiers.platform && ... }, |this, window, cx| { logging::log(...); this.toggle_arg_actions(cx, window); }, |this, action_id, cx| { this.trigger_action_by_name(action_id, cx); }, |_key, _key_char, _modifiers| true, |this, matched_shortcut, cx| { logging::log(...); this.trigger_action_by_name(...); })` should be replaced with `handle_prompt_key_preamble_default(this, event, window, cx, PromptKeyPreambleCfg { is_dismissable: true, stop_propagation_on_global_shortcut: false, stop_propagation_when_handled: false, host: ActionsDialogHost::ArgPrompt }, has_actions_for_handler, "ArgPrompt")`. Apply the same pattern in `src/render_prompts/div.rs` (lines ~34-67) with `host: ActionsDialogHost::DivPrompt`, `is_dismissable: true`, `stop_propagation_on_global_shortcut: true`, `stop_propagation_when_handled: true`, and `prompt_label: "DivPrompt"`. Apply the same pattern in `src/render_prompts/form/render.rs` (lines ~41-73) with `host: ActionsDialogHost::FormPrompt` and `prompt_label: "FormPrompt"`.

Each call site currently captures `has_actions_for_handler` (a `bool`) in the closure — pass this directly to `handle_prompt_key_preamble_default`. The `PromptKeyPreambleCfg` values differ per prompt (div has `stop_propagation_on_global_shortcut: true` and `stop_propagation_when_handled: true`, while arg and form have both as `false`) — preserve these exactly. Do NOT modify the editor or term call sites — they have legitimately different logic. Do NOT change any existing tests. Verify with `cargo check && cargo clippy --all-targets -- -D warnings && cargo test`. The existing `include_str!` tests that check for `"handle_prompt_key_preamble("` should still pass because `handle_prompt_key_preamble_default` contains that substring.

**IMPORTANT**: The existing tests in arg/render.rs check `ARG_RENDER_SOURCE.contains("handle_prompt_key_preamble(")` — the new call `handle_prompt_key_preamble_default(` still contains the substring `handle_prompt_key_preamble(` so the test will pass. Similarly for div and form tests. But double-check that the test for `"PromptKeyPreambleCfg"` still passes — the new call still includes `PromptKeyPreambleCfg { ... }` inline so that's fine.

NEXT_AREA: The `render_actions_backdrop()` call with `ActionsBackdropConfig` is also duplicated across all 5 renderers with nearly identical structure — each passes the same fields with only `backdrop_id`, `close_host`, and `backdrop_log_message` differing. This could benefit from a similar default-builder pattern.
