<project-conventions>
# Script Kit GPUI

Rust (GPUI app shell) + TypeScript (bun script runner) + SDK. Backwards-compatible rewrite of Script Kit.

## Scope Rules

- Do ONLY what is explicitly requested. No unrequested changes, refactors, or "improvements."
- If you notice something worth improving, mention it at the end — do not implement it.
- Stay within the boundaries of the task. A docs request is not a code change.

## Verification Gate (Mandatory)

Every code change must pass before reporting success:

```bash
cargo check && cargo clippy --all-targets -- -D warnings && cargo test
```

After the gate passes, verify the change actually works:
- **Logic changes**: check logs with `SCRIPT_KIT_AI_LOG=1`
- **UI changes**: capture screenshot AND read the PNG to confirm visually
- **Never** report success without running verification

## Build & Test

| Action | Command |
|--------|---------|
| Check | `cargo check` |
| Lint | `cargo clippy --all-targets -- -D warnings` |
| Test | `cargo test` |
| Test (system) | `cargo test --features system-tests` |
| Test (slow) | `cargo test --features slow-tests` |
| Run | `echo '{"type":"show"}' \| SCRIPT_KIT_AI_LOG=1 ./target/debug/script-kit-gpui 2>&1` |
| Bundle | `cargo bundle --release` |

## Coding Conventions

### Rust
- Use `?` or graceful error handling — never `unwrap()` in unsafe/ObjC code
- After any render-affecting mutation: `cx.notify()`
- Use `theme.colors.*` — never hardcode `rgb(0x...)`
- Keyboard keys — match both variants:
  ```rust
  match key.as_str() {
    "up" | "arrowup" => ...,
    "down" | "arrowdown" => ...,
    "enter" | "Enter" => ...,
    "escape" | "Escape" => ...,
    _ => {}
  }
  ```

### UI Testing
- **Never** pass scripts as CLI args — use stdin JSON protocol
- Always use `SCRIPT_KIT_AI_LOG=1` for compact log output
- After screenshots, **read the PNG file** to verify

## Architecture Quick Ref

- Built-in commands: `BuiltInFeature` enum → `get_builtin_entries()` → `execute_builtin()` → `AppView` variant → render
- Non-dismissable views: add to `is_dismissable_view()` in `app_impl.rs`
- Vibrancy: prompts should NOT set opaque bg — let vibrancy show through from Root
- Render wrappers: `render_prompts/other.rs` wraps prompt entities, `prompts/*.rs` are inner components
- Protocol: bidirectional JSONL over stdin/stdout between bun scripts and Rust app — see `docs/PROTOCOL.md`

## Consistency Rules (Non-Negotiable)

These rules exist because mixed patterns break both human navigation and AI agent effectiveness.

### 1) No `part_*.rs` files
- Do NOT create or extend `part_000.rs`, `part_001.rs`, etc.
- Do NOT use `include!("part_*.rs")` for hand-written code.
- If a module is too large, split into a directory module with named files:
  - `mod.rs` is a facade that does `mod foo; mod bar;` and `pub use ...;`
  - Filenames must be semantic (`model.rs`, `render.rs`, `storage.rs`), never numeric.

### 2) Tests have only two homes (pick the right one)
- Unit tests live next to code
</project-conventions>

<recent-commits>
e8da494e refactor(terminal): extract theme adapter color constants
3737e167 refactor(theme): extract polling backoff constants
7dd41e81 fix(theme): allow appearance and on_accent validation keys
8cfa13d1 fix(theme): remove dead option hex color serde module
dc097260 fix(theme): use text.on_accent for selected list text
b5eaddab fix(theme): derive prompt is_dark from color scheme
d1683e67 refactor(theme): dedupe list item colors type
837d3abf fix(cursor): remove dead cursor coordination stubs
2f6e0219 refactor(toast): remove dead transition types and unused toast fields
4ec1bbf8 fix(cursor): remove dynamic cursor forcing handlers
5f782da2 fix(theme): add structured tracing for theme load mapping
7c6fa4dc fix(render_builtins): use gpui transparent black helper
1bee00e7 feat(theme): add resolver and semantic debug tracing
c086396d test(theme): add snapshot characterization test home
2a9982bc refactor(toast_manager): remove dead queue lifecycle APIs
</recent-commits>

These commits were ALREADY MADE — do NOT suggest changes that duplicate this work.

<previous-iterations>


Here are the swarm tasks extracted:

- `fix-text-on-accent-resolution` scope:`src/{theme/helpers.rs,list_item/mod.rs,prompts/base.rs}` — Replace `colors.text.primary` with `colors.text.on_accent` at 3 call sites
- `dedupe-list-item-colors` scope:`src/{theme/helpers.rs,list_item/mod.rs}` — Remove duplicate Rgba-based `ListItemColors` struct, use canonical u32 version
- `unify-merged-part-comments` scope:`src/{list_item/mod.rs,theme/types.rs}` — Delete stale `// --- merged from part_XXX.rs ---` comments (10 occurrences)
- `fix-helpers-is-dark-default` scope:`src/theme/helpers.rs` — Derive `is_dark` from color scheme instead of hardcoding `true`

NEXT_AREA: `src/designs/traits/colors.rs` — design variant color definitions from multiple agents, potential missing fields and inconsistent contrast
---


Here are the extracted swarm tasks:

- `rm-background-role-dead-code` scope:`src/theme/types.rs, src/theme/mod.rs, src/theme/prelude.rs` — Delete BackgroundRole enum, hex_to_rgba_components, background_rgba, get_opacity_for_focus, DropShadow::clamped, TerminalColors::get, invalidate_theme_cache
- `rm-dead-test-helpers` scope:`src/theme/tests/helpers.rs, src/theme/tests/core.rs, src/theme/theme_tests/mod.rs` — Delete tests referencing BackgroundRole, background_rgba, get_opacity_for_focus, DropShadow::clamped, TerminalColors::get
- `rm-semantic-module` scope:`src/theme/semantic.rs, src/theme/mod.rs, src/theme/prelude.rs` — Delete entire semantic.rs module and all its re-exports
- `rm-hex-option-serde` scope:`src/theme/hex_color.rs` — Delete dead hex_color_option_serde module

NEXT_AREA: `src/theme/service.rs` — stale `#![allow(dead_code)]` on a live module; some items may be truly dead

Want me to execute these as a swarm?
---
All 4 tasks have **already been completed** in recent commits:

| Worker | Task | Commit |
|--------|------|--------|
| `theme-validation-known-keys` | Add `appearance` and `on_accent` to validation allow-lists | `7dd41e81` |
| `theme-service-polling-constants` | Extract polling backoff magic numbers to named constants | `3737e167` |
| `terminal-theme-adapter-default-palette-constants` | Extract terminal theme adapter color constants | `e8da494e` |
| `icons-render-color-tokens-or-constants` | Replace test-only magic `rgb(0x...)` with named constants | In working tree (`src/icons/render.rs` modified) |

The working tree has uncommitted changes from what looks like a prior xorloop session. The remaining diff touches `src/icons/render.rs` (task 4) plus some theme file cleanup (deleted `semantic.rs`, removed tests).

Would you like me to:
1. Verify the current state passes the gate (`cargo check && cargo clippy && cargo test`)?
2. Commit the remaining uncommitted work?
3. Something else?

**NEXT_AREA:** `src/theme/validation.rs` — extend validation to cover nested `colors.terminal` keys and `focus_aware` sub-objects (`focused`/`unfocused`) so invalid terminal palettes get actionable diagnostics.
---
</previous-iterations>

These areas were ALREADY addressed in earlier iterations. Do NOT re-analyze them. Find something completely different.

## Target Code

I found the issue. In `helpers.rs:53`, `InputFieldColors.text` is set to `rgb(colors.text.on_accent)`. The `on_accent` color is `0xffffff` (white) in both dark AND light themes — it's meant for text rendered on top of accent-colored backgrounds (like selected item badges). But for an input field on a light background, white text would be invisible. The correct token for input field text should be `text.primary`.

Let me verify by checking the light theme's `text.on_accent`:

The light theme at `types.rs:804` has `on_accent: 0xffffff` (white) and `primary: 0x000000` (black). So on a light theme, input field text using `on_accent` would be white-on-white — invisible.

FEATURE: `InputFieldColors` pre-computes text colors for search boxes and text inputs, but maps the typing text color to `text.on_accent` (white) instead of `text.primary`, making input text invisible on light theme backgrounds.
FILES: src/theme/helpers.rs, src/theme/types.rs, src/theme/tests/helpers.rs
SMELL: `InputFieldColors::from_color_scheme` uses `text.on_accent` (always white, designed for text on accent-colored badges) as the input text color, so typing in any input field on a light theme renders white text on a white/light background — completely unreadable.

## Task: UX polish: find UI inconsistencies, missing keyboard shortcuts, broken focus management, hardcoded colors instead of theme tokens, missing cx.notify() after mutations — fix them

## CONTEXT: You are generating work orders for a codex-swarm

This is a large codebase primarily written by AI agents. Different agents made different choices, leading to inconsistencies, duplicated patterns, mixed conventions, and rough edges throughout. Your job is to find real quality issues and generate precise work orders to fix them.

Your output will be handed DIRECTLY to a `/codex-swarm` dispatcher that spawns parallel Codex AI agents (GPT-5.3) to implement your recommendations. Each task you write becomes a worker that edits real files autonomously. The workers have NO context beyond what you write in the task description — they cannot ask questions.

If a CLAUDE.md or project-conventions block was provided above, the workers MUST follow those rules. Include relevant conventions in each task description.

## Output Format — SWARM TASK LIST

Output 1-4 tasks. For each task, output this EXACT structure:

### Task N: `<worker-id>`

**Scope:** `<glob pattern for files this worker should touch>`

**Task:**
<2-4 paragraphs briefing a senior engineer. Be EXHAUSTIVE — the worker has zero context beyond this text.>

<Paragraph 1: What is wrong, which specific files/functions/lines are involved, and what the fix should accomplish.>

<Paragraph 2: The exact implementation — what code to change, what the replacement should look like, what patterns to follow from the existing codebase. Include function signatures, variable names, types.>

<Paragraph 3: Edge cases and constraints — what NOT to break, what to watch out for, how to verify the fix works.>

## Rules

- Worker IDs must be short kebab-case: `fix-fts-trigger`, `add-search-debounce`, `rm-dead-exports`
- Scope must be a glob: `src/notes/storage.rs`, `src/auth/**/*.ts`, `src/menu_bar/*.rs`
- Each worker should own at most ~10 files. If a fix spans more, split into multiple tasks
- Task descriptions must be SELF-CONTAINED — include file paths, function names, current buggy code snippets, and what the corrected code should look like
- Do NOT suggest adding documentation, comments, or docstrings — only functional code changes
- Do NOT suggest adding logging unless it fixes an actual bug
- Prioritize by impact: bugs > security > performance > cleanup
- Maximum 4 tasks per iteration — fewer is better if they're high-quality
- End with: NEXT_AREA: <suggest one unexplored area for future analysis>
