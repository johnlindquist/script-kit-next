<project-conventions>
# Script Kit GPUI

Rust (GPUI app shell) + TypeScript (bun script runner) + SDK. Backwards-compatible rewrite of Script Kit.

## Scope Rules

- Do ONLY what is explicitly requested. No unrequested changes, refactors, or "improvements."
- If you notice something worth improving, mention it at the end — do not implement it.
- Stay within the boundaries of the task. A docs request is not a code change.

## Verification Gate (Mandatory)

Every code change must pass before reporting success:

```bash
cargo check && cargo clippy --all-targets -- -D warnings && cargo test
```

After the gate passes, verify the change actually works:
- **Logic changes**: check logs with `SCRIPT_KIT_AI_LOG=1`
- **UI changes**: capture screenshot AND read the PNG to confirm visually
- **Never** report success without running verification

## Build & Test

| Action | Command |
|--------|---------|
| Check | `cargo check` |
| Lint | `cargo clippy --all-targets -- -D warnings` |
| Test | `cargo test` |
| Test (system) | `cargo test --features system-tests` |
| Test (slow) | `cargo test --features slow-tests` |
| Run | `echo '{"type":"show"}' \| SCRIPT_KIT_AI_LOG=1 ./target/debug/script-kit-gpui 2>&1` |
| Bundle | `cargo bundle --release` |

## Coding Conventions

### Rust
- Use `?` or graceful error handling — never `unwrap()` in unsafe/ObjC code
- After any render-affecting mutation: `cx.notify()`
- Use `theme.colors.*` — never hardcode `rgb(0x...)`
- Keyboard keys — match both variants:
  ```rust
  match key.as_str() {
    "up" | "arrowup" => ...,
    "down" | "arrowdown" => ...,
    "enter" | "Enter" => ...,
    "escape" | "Escape" => ...,
    _ => {}
  }
  ```

### UI Testing
- **Never** pass scripts as CLI args — use stdin JSON protocol
- Always use `SCRIPT_KIT_AI_LOG=1` for compact log output
- After screenshots, **read the PNG file** to verify

## Architecture Quick Ref

- Built-in commands: `BuiltInFeature` enum → `get_builtin_entries()` → `execute_builtin()` → `AppView` variant → render
- Non-dismissable views: add to `is_dismissable_view()` in `app_impl.rs`
- Vibrancy: prompts should NOT set opaque bg — let vibrancy show through from Root
- Render wrappers: `render_prompts/other.rs` wraps prompt entities, `prompts/*.rs` are inner components
- Protocol: bidirectional JSONL over stdin/stdout between bun scripts and Rust app — see `docs/PROTOCOL.md`

## Consistency Rules (Non-Negotiable)

These rules exist because mixed patterns break both human navigation and AI agent effectiveness.

### 1) No `part_*.rs` files
- Do NOT create or extend `part_000.rs`, `part_001.rs`, etc.
- Do NOT use `include!("part_*.rs")` for hand-written code.
- If a module is too large, split into a directory module with named files:
  - `mod.rs` is a facade that does `mod foo; mod bar;` and `pub use ...;`
  - Filenames must be semantic (`model.rs`, `render.rs`, `storage.rs`), never numeric.

### 2) Tests have only two homes (pick the right one)
- Unit tests live next to code
</project-conventions>

<recent-commits>
94b2f1c1 refactor(input_detection): use static LazyLock for regex in is_code_snippet
2bca9dd6 refactor(search): replace score literals with constants
5f011b40 refactor(search): unify SearchResult type sort ordering
f21b8e56 refactor(search): remove dead nucleo helper and test-gate ascii helpers
94477ed3 refactor(executor): remove dead ScriptSession helpers
7e526066 fix(executor): prune stale runner re-exports
fdc1f312 refactor(executor): remove unused crash infra paths
a2e43371 fix(executor): remove dead blocking runner paths
a147211e fix(storybook): replace hardcoded colors with theme tokens in browser
f48e95bf fix(stories): replace Menlo with FONT_MONO
6e6e1611 fix(fonts): replace Menlo with FONT_MONO in prompt renderers
3ec6188e fix(toast): use FONT_MONO for details font family
fb5c08c6 fix(ui): centralize transparent rgba token usage
b5e93aae fix(toast): remove dead details expansion toggle
49d6f9bc chore(ui): remove dead editor and vibrancy helpers
</recent-commits>

These commits were ALREADY MADE — do NOT suggest changes that duplicate this work.

<previous-iterations>
Here are the swarm tasks:

- `fix-storybook-browser-theme` scope:`src/storybook/browser.rs` — Replace 27 hardcoded rgb hex colors with theme.colors.* tokens
- `fix-storybook-layout-theme` scope:`src/storybook/layout.rs` — Replace 5 hardcoded rgb hex colors with theme tokens, Menlo with FONT_MONO
- `fix-menlo-to-font-mono` scope:`src/prompts/**/*, src/term_prompt/*` — Replace hardcoded "Menlo" font with FONT_MONO constant in 6 prompt files
- `fix-stories-menlo-font` scope:`src/stories/*` — Replace hardcoded "Menlo" font with FONT_MONO in 3 story files

NEXT_AREA: `src/stories/` — 150 hardcoded `rgb(0x...)` calls across 20 story files need theme token migration
---
Here are the swarm tasks:

- `rm-dead-blocking-exec` scope:`src/executor/runner.rs` — Remove dead `execute_script`, `run_command`, and `ensure_tsconfig_paths` functions
- `rm-dead-session-methods` scope:`src/executor/runner.rs` — Remove dead `ScriptSession` impl block with 6 unused methods
- `rm-dead-crash-infra` scope:`src/executor/errors.rs, src/executor/mod.rs` — Remove unused `CrashInfo`, `signal_to_name`, `generate_crash_suggestions`
- `rm-stale-mod-exports` scope:`src/executor/mod.rs` — Remove stale re-exports of deleted functions from mod facade

NEXT_AREA: `src/executor/scriptlet.rs` — the `execute_*` dispatch functions (~20 functions, ~600 lines) may contain dead or duplicated dispatch paths
---


Looking at the analysis, here are the swarm tasks:

- `fix-regex-lazy-lock` scope:`src/scripts/input_detection/detection.rs` — Hoist two per-call Regex::new into static LazyLock declarations
- `rm-dead-search-helpers` scope:`src/scripts/search/{nucleo,ascii}.rs` — Delete deprecated nucleo_score, cfg(test)-gate dead ascii helpers
- `dedup-type-order-unified` scope:`src/scripts/search/unified.rs` — Extract duplicated type_order closure into standalone function
- `name-score-constants` scope:`src/scripts/search/{scripts,scriptlets}.rs` — Replace ~40 magic score literals with named constants

NEXT_AREA: `src/scripts/search/builtins.rs` and `src/scripts/search/apps.rs` scoring patterns — likely have same magic-number problem and duplicated logic that could unify into a shared scoring helper module
---
</previous-iterations>

These areas were ALREADY addressed in earlier iterations. Do NOT re-analyze them. Find something completely different.

## Target Code

FEATURE: List items truncate names/descriptions with text_ellipsis but provide no tooltip or overflow mechanism, so users cannot read long script names or descriptions that exceed the item width.
FILES: src/list_item/mod.rs, src/designs/core/render.rs, src/render_script_list/mod.rs
SMELL: Four `.text_ellipsis()` calls (lines 1070, 1087, 1151, 1160 in list_item/mod.rs) silently clip text with zero tooltip fallback — `grep tooltip src/list_item/` returns nothing — making long script names permanently unreadable unless the user opens the script.

## Task: UX polish: find UI inconsistencies, missing keyboard shortcuts, broken focus management, hardcoded colors instead of theme tokens, missing cx.notify() after mutations — fix them

## CONTEXT: You are generating work orders for a codex-swarm

This is a large codebase primarily written by AI agents. Different agents made different choices, leading to inconsistencies, duplicated patterns, mixed conventions, and rough edges throughout. Your job is to find real quality issues and generate precise work orders to fix them.

Your output will be handed DIRECTLY to a `/codex-swarm` dispatcher that spawns parallel Codex AI agents (GPT-5.3) to implement your recommendations. Each task you write becomes a worker that edits real files autonomously. The workers have NO context beyond what you write in the task description — they cannot ask questions.

If a CLAUDE.md or project-conventions block was provided above, the workers MUST follow those rules. Include relevant conventions in each task description.

## Output Format — SWARM TASK LIST

Output 1-4 tasks. For each task, output this EXACT structure:

### Task N: `<worker-id>`

**Scope:** `<glob pattern for files this worker should touch>`

**Task:**
<2-4 paragraphs briefing a senior engineer. Be EXHAUSTIVE — the worker has zero context beyond this text.>

<Paragraph 1: What is wrong, which specific files/functions/lines are involved, and what the fix should accomplish.>

<Paragraph 2: The exact implementation — what code to change, what the replacement should look like, what patterns to follow from the existing codebase. Include function signatures, variable names, types.>

<Paragraph 3: Edge cases and constraints — what NOT to break, what to watch out for, how to verify the fix works.>

## Rules

- Worker IDs must be short kebab-case: `fix-fts-trigger`, `add-search-debounce`, `rm-dead-exports`
- Scope must be a glob: `src/notes/storage.rs`, `src/auth/**/*.ts`, `src/menu_bar/*.rs`
- Each worker should own at most ~10 files. If a fix spans more, split into multiple tasks
- Task descriptions must be SELF-CONTAINED — include file paths, function names, current buggy code snippets, and what the corrected code should look like
- Do NOT suggest adding documentation, comments, or docstrings — only functional code changes
- Do NOT suggest adding logging unless it fixes an actual bug
- Prioritize by impact: bugs > security > performance > cleanup
- Maximum 4 tasks per iteration — fewer is better if they're high-quality
- End with: NEXT_AREA: <suggest one unexplored area for future analysis>
