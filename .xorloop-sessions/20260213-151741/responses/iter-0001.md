Got the full response. Here's Oracle's analysis and swarm task list:

---

## Oracle (GPT-5.2 Pro) Analysis — Watcher Refactoring

Oracle identified 6 duplicated code blocks across the 4 watchers and produced 4 tasks. It also found **2 bugs** to fix during migration.

---

### Task 1: `watcher-core`
**Scope:** `src/watcher/{mod.rs,generic.rs}`

Create the shared generic engine: `Watcher<E, Tx, Spec>` + `WatcherSpec` trait + `EventSink` trait. The generic owns the lifecycle (tx, stop flag, join handle) and the shared supervisor/backoff/watch_loop/Drop logic. The trait shape:
- `label()` — for tracing fields
- `setup()` — do all `watcher.watch()` calls + per-attempt state init
- `next_deadline()` — returns absolute deadline instant
- `on_timeout()` — flush debounce / emit events
- `on_notify()` — update pending state, schedule reloads, dynamic watch additions

`EventSink<E>` abstracts over `mpsc::Sender` vs `async_channel::Sender`.

**Bug fix included:** Wire `ControlMsg::Stop` properly in Drop — currently Drop blocks up to `health_check_interval_ms` waiting for the next timeout tick. Store `Arc<Mutex<Option<Sender<ControlMsg>>>>` and send Stop on drop to wake immediately.

---

### Task 2: `config-theme-migration`
**Scope:** `src/watcher/specs/*.rs`

Create `SingleFileReloadSpec<E>` for the simple single-file-watch case. Migrate `ConfigWatcher` and `ThemeWatcher` to thin wrappers over the generic. Only differences: event type, emit value, label, and target path.

---

### Task 3: `script-migration`
**Scope:** `src/watcher/specs/script.rs`

Migrate `ScriptWatcher` — the most complex one with per-file pending state, storm coalescing, and dynamic extension/agent dir watching.

**Bug fix included:** Move `discover_kit_watch_paths()` into `setup()` so it runs every supervisor restart attempt (currently done once in `start()` and reused via clone — new kits created during backoff are missed). Also extend `all_extensions_paths`/`all_agents_paths` when new kit dirs are detected.

---

### Task 4: `app-migration`
**Scope:** `src/watcher/specs/app.rs`

Migrate `AppWatcher` with its `async_channel` sender.

**Bug fix included:** `~/Applications` is silently skipped if it doesn't exist at startup and events for later-installed apps are permanently missed. Fix: `create_dir_all` best-effort before watching.

---

**NEXT_AREA:** Audit "restart correctness" — what state must be recomputed per supervisor attempt, and which directories/files can be permanently missed if created while a watcher is down.

---

Want me to proceed with implementing these tasks (e.g., via codex-swarm), or would you like to review/adjust the plan first?
