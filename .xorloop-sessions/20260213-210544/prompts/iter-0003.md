<project-conventions>
# Script Kit GPUI

Rust (GPUI app shell) + TypeScript (bun script runner) + SDK. Backwards-compatible rewrite of Script Kit.

## Scope Rules

- Do ONLY what is explicitly requested. No unrequested changes, refactors, or "improvements."
- If you notice something worth improving, mention it at the end — do not implement it.
- Stay within the boundaries of the task. A docs request is not a code change.

## Verification Gate (Mandatory)

Every code change must pass before reporting success:

```bash
cargo check && cargo clippy --all-targets -- -D warnings && cargo test
```

After the gate passes, verify the change actually works:
- **Logic changes**: check logs with `SCRIPT_KIT_AI_LOG=1`
- **UI changes**: capture screenshot AND read the PNG to confirm visually
- **Never** report success without running verification

## Build & Test

| Action | Command |
|--------|---------|
| Check | `cargo check` |
| Lint | `cargo clippy --all-targets -- -D warnings` |
| Test | `cargo test` |
| Test (system) | `cargo test --features system-tests` |
| Test (slow) | `cargo test --features slow-tests` |
| Run | `echo '{"type":"show"}' \| SCRIPT_KIT_AI_LOG=1 ./target/debug/script-kit-gpui 2>&1` |
| Bundle | `cargo bundle --release` |

## Coding Conventions

### Rust
- Use `?` or graceful error handling — never `unwrap()` in unsafe/ObjC code
- After any render-affecting mutation: `cx.notify()`
- Use `theme.colors.*` — never hardcode `rgb(0x...)`
- Keyboard keys — match both variants:
  ```rust
  match key.as_str() {
    "up" | "arrowup" => ...,
    "down" | "arrowdown" => ...,
    "enter" | "Enter" => ...,
    "escape" | "Escape" => ...,
    _ => {}
  }
  ```

### UI Testing
- **Never** pass scripts as CLI args — use stdin JSON protocol
- Always use `SCRIPT_KIT_AI_LOG=1` for compact log output
- After screenshots, **read the PNG file** to verify

## Architecture Quick Ref

- Built-in commands: `BuiltInFeature` enum → `get_builtin_entries()` → `execute_builtin()` → `AppView` variant → render
- Non-dismissable views: add to `is_dismissable_view()` in `app_impl.rs`
- Vibrancy: prompts should NOT set opaque bg — let vibrancy show through from Root
- Render wrappers: `render_prompts/other.rs` wraps prompt entities, `prompts/*.rs` are inner components
- Protocol: bidirectional JSONL over stdin/stdout between bun scripts and Rust app — see `docs/PROTOCOL.md`

## Consistency Rules (Non-Negotiable)

These rules exist because mixed patterns break both human navigation and AI agent effectiveness.

### 1) No `part_*.rs` files
- Do NOT create or extend `part_000.rs`, `part_001.rs`, etc.
- Do NOT use `include!("part_*.rs")` for hand-written code.
- If a module is too large, split into a directory module with named files:
  - `mod.rs` is a facade that does `mod foo; mod bar;` and `pub use ...;`
  - Filenames must be semantic (`model.rs`, `render.rs`, `storage.rs`), never numeric.

### 2) Tests have only two homes (pick the right one)
- Unit tests live next to code
</project-conventions>

<recent-commits>
6518960e fix(preview-panel): derive light badge colors from ui border
c5b94717 fix(theme-chooser): theme-based vibrancy knob colors
3fac426c refactor(theme): unify modal overlay background helper usage
fdeda0c1 fix(command-bar-ui): derive popup/keycap overlays from theme
6dbf27fe refactor(term): route key preamble through shared helper
8282a3c0 refactor(prompts): route div/editor preamble through helper
6307863e refactor(prompts): share key preamble flow in arg and form
d09920f8 revert(actions): remove descriptions, accent border, and shadow from popup
8e725e13 refactor(actions-toggle): extract popup open preamble helper
3532545e refactor(app_impl): share actions window spawn-open logic
6afc15bc refactor(actions-toggle): extract on_close callback factory
e43267c0 refactor(prompt_handler): dedup prompt window and submit helpers
9d2111b2 refactor(executor): dedupe runtime fallback chain
e8980c9b fix(cursor): replace push/pop with set to eliminate flickering
a999b613 fix(confirm): replace expect/swallowed errors with proper error handling
</recent-commits>

These commits were ALREADY MADE — do NOT suggest changes that duplicate this work.

<previous-iterations>


Here are the extracted swarm tasks:

- `core-helper` scope:`src/render_prompts/arg/helpers.rs` — Add shared `handle_actions_routing` helper centralizing duplicated actions routing sequence
- `arg-form-migration` scope:`src/render_prompts/{arg,form}/render.rs` — Refactor arg and form key handlers to use new `handle_actions_routing` helper
- `div-migration` scope:`src/render_prompts/div.rs` — Refactor div key handler to use `handle_actions_routing` with stop_propagation
- `editor-term-migration` scope:`src/render_prompts/{editor.rs,term.rs}` — Migrate editor and term to use `handle_actions_routing` with LetThrough mode

NEXT_AREA: `render_actions_backdrop` call pattern — duplicated ~15-line backdrop rendering block across prompt types
---
All four tasks have already been completed in recent commits:

- **Task 1** `theme-command-bar-colors` — Done in `fdeda0c1`
- **Task 2** `unify-modal-overlay-bg` — Done in `3fac426c`
- **Task 3** `theme-toggle-knob` — Done in `c5b94717`
- **Task 4** `theme-preview-badges` — Done in `6518960e`

Here's the extracted task list for reference (all already landed on `main`):

---

- `theme-command-bar-colors` scope:`src/terminal/command_bar_ui/render.rs` — derive popup shadow and keycap overlay colors from theme
- `unify-modal-overlay-bg` scope:`src/notes/browse_panel.rs, src/notes/window.rs, src/notes/window/vibrancy.rs, src/ai/window/theme_helpers.rs` — replace duplicate overlay-bg functions with canonical modal_overlay_bg helper
- `theme-toggle-knob` scope:`src/render_builtins/theme_chooser.rs` — replace hardcoded white knob with theme-derived text colors
- `theme-preview-badges` scope:`src/app_render/preview_panel.rs` — derive light-mode badge bg/border from ui_border instead of hardcoded black

NEXT_AREA: `create_box_shadows` / shadow computation — at least 3 divergent shadow creation patterns across modules (`app_shell/style.rs` uses inline Hsla, `ai/window/theme_helpers.rs` has a 40-line RGB→HSL conversion, `notes/actions_panel.rs` uses named constants, `terminal/command_bar_ui` now uses theme-derived rgba) — could be unified into a shared shadow builder utility
---
</previous-iterations>

These areas were ALREADY addressed in earlier iterations. Do NOT re-analyze them. Find something completely different.

## Target Code

FEATURE: List navigation functions re-scan the entire grouped items list on every keystroke to find first/last selectable indices, instead of caching these O(1) boundary values alongside the already-cached grouped list
FILES: src/app_navigation/impl_movement.rs, src/app_navigation/helpers.rs, src/app_impl/filtering_cache.rs
SMELL: Every arrow-key/page-up/page-down press calls `.iter().position()` or `.iter().rposition()` over the full `Arc<[GroupedListItem]>` to locate the first/last non-header item — redundant linear scans on a list that only changes when the filter text changes, where `get_grouped_results_cached` already caches the list itself but not these boundary indices

## Task: performance fix: find O(n^2) loops, redundant clones, unnecessary allocations, repeated I/O, blocking on the render/UI thread — write the optimized replacement

## CONTEXT: You are generating work orders for a codex-swarm

This is a large codebase primarily written by AI agents. Different agents made different choices, leading to inconsistencies, duplicated patterns, mixed conventions, and rough edges throughout. Your job is to find real quality issues and generate precise work orders to fix them.

Your output will be handed DIRECTLY to a `/codex-swarm` dispatcher that spawns parallel Codex AI agents (GPT-5.3) to implement your recommendations. Each task you write becomes a worker that edits real files autonomously. The workers have NO context beyond what you write in the task description — they cannot ask questions.

If a CLAUDE.md or project-conventions block was provided above, the workers MUST follow those rules. Include relevant conventions in each task description.

## Output Format — SWARM TASK LIST

Output 1-4 tasks. For each task, output this EXACT structure:

### Task N: `<worker-id>`

**Scope:** `<glob pattern for files this worker should touch>`

**Task:**
<2-4 paragraphs briefing a senior engineer. Be EXHAUSTIVE — the worker has zero context beyond this text.>

<Paragraph 1: What is wrong, which specific files/functions/lines are involved, and what the fix should accomplish.>

<Paragraph 2: The exact implementation — what code to change, what the replacement should look like, what patterns to follow from the existing codebase. Include function signatures, variable names, types.>

<Paragraph 3: Edge cases and constraints — what NOT to break, what to watch out for, how to verify the fix works.>

## Rules

- Worker IDs must be short kebab-case: `fix-fts-trigger`, `add-search-debounce`, `rm-dead-exports`
- Scope must be a glob: `src/notes/storage.rs`, `src/auth/**/*.ts`, `src/menu_bar/*.rs`
- Each worker should own at most ~10 files. If a fix spans more, split into multiple tasks
- Task descriptions must be SELF-CONTAINED — include file paths, function names, current buggy code snippets, and what the corrected code should look like
- Do NOT suggest adding documentation, comments, or docstrings — only functional code changes
- Do NOT suggest adding logging unless it fixes an actual bug
- Prioritize by impact: bugs > security > performance > cleanup
- Maximum 4 tasks per iteration — fewer is better if they're high-quality
- End with: NEXT_AREA: <suggest one unexplored area for future analysis>
