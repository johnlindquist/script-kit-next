Here's the full Oracle analysis of documentation gaps in the text expansion trigger system:

---

## Documentation Gaps — Text Expansion System

### Critical (3)

1. **Stale architecture docs describe behavior the code no longer does**
   `src/keyword_manager/mod.rs` L1-L21 — Module docs claim scriptlets load from `~/.scriptkit/scriptlets/` while `load_scriptlets` says `~/.scriptkit/kit/*/extensions/`. Docs describe stopping/resuming the keyboard monitor around expansion, but `enable()` performs expansion in a spawned thread without any stop/restart sequence. **Fix:** Rewrite the `//! # Architecture` steps to match reality; add a data-contract section for `Scriptlet` fields.

2. **No privacy/safety docs for keystroke logging**
   `src/keystroke_logger.rs` L1-L5, L25-L26, L145-L158 — The logger stores and debug-logs a rolling window of recently typed characters (`recent_chars`) which can capture passwords/tokens. No warning exists. **Fix:** Add a blunt privacy warning to module docs; document the redaction policy and flush() log-level gating.

3. **Undocumented "tool type" fallback behavior for keyword expansions**
   `src/keyword_manager/mod.rs` L313-L335 — Only `"paste" | "type" | "template"` are handled; all other tools silently fall back to raw content paste with an info log. The `KeywordScriptlet.tool` field doc says "execute vs paste (future use)" but doesn't state the current reality. **Fix:** Add a `# Tool handling` section listing supported tools and the silent fallback.

### Major (7)

4. **Misleading timing docs** — `STOP_DELAY_MS`/`RESTART_DELAY_MS` docs reference "stop/restart monitor" but no stop/restart exists. `restart_delay_ms` is unused.

5. **Undocumented keystroke filtering rules** — Modifier suppression (`cmd|ctrl|option` → "skipped"), `event.character` multi-char handling, chars-not-keycodes processing — none in rustdoc.

6. **Variable substitution is undocumented** — `substitute_variables(&raw_content)` is a core expansion step (L332-L340) described only in inline comments.

7. **File path anchor stripping invariant undocumented** — `file_triggers` keys depend on `#slug` stripping but `update_triggers_for_file` doesn't document it expects normalized paths.

8. **`MatchResult.scriptlet_path` is misleading** — Documented as "Path to the scriptlet to execute" but can be a synthetic `"manual:NAME"` ID. `KeywordMatcher` doesn't execute anything.

9. **Matching semantics scattered across inline comments** — Buffer-clearing chars, tie-break rules (longest-first, then alpha), overlapping trigger behavior, Unicode char-count vs byte-count — none in public rustdoc.

10. **No scriptlet authoring guidance for `keyword` triggers** — `ScriptletMetadata.keyword` exists but module docs don't explain how to write one. `parse_html_comment_metadata` silently accepts `"expand"` as a legacy alias without documenting it.

### Minor (2)

11. **Stale inline comments in scriptlet parsing** — "valid tool or metadata/schema block" comment doesn't match the check (L593-L608); "tool matches" comment doesn't match behavior (L859-L863).

12. **Non-macOS stubs lack rustdoc** — `init_keyword_manager` and `update_keyword_triggers_for_file` stubs have no docs; `is_keyword_manager_enabled` doesn't mention it returns `false` before init or on non-macOS.

---

**NEXT_AREA:** `src/keyboard_monitor/*` — KeyEvent semantics, `event.character` guarantees, modifier handling, accessibility permission flow, and how synthetic/injected keystrokes are distinguished from real ones.
